{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="mb-1">Configurações</h2>
        <p class="mb-0 text-muted">Gestão administrativa do sistema.</p>
    </div>
    <a href="{{ url_for('ponto.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i> Voltar
    </a>
</div>

<!-- Mensagens Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
    {% if category == 'danger' %}
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {% elif category == 'warning' %}
    <i class="bi bi-exclamation-circle-fill me-2"></i>
    {% elif category == 'success' %}
    <i class="bi bi-check-circle-fill me-2"></i>
    {% else %}
    <i class="bi bi-info-circle-fill me-2"></i>
    {% endif %}
    {{ message|safe }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center p-3">
                <h3 class="mb-0 text-primary">{{ kpi_mttr }}h</h3>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">MTTR Médio</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center p-3">
                <h3 class="mb-0 text-success">{{ kpi_os_concluidas }}</h3>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Manutenções Feitas</small>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs nav-fill mb-4 border-bottom-0" id="adminTabs" role="tablist">
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'tecnicos' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#tecnicos">Usuários</button>
    </li>
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'equipamentos' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#equipamentos">Equipamentos</button>
    </li>
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'unidades' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#unidades">Unidades</button>
    </li>
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'catalogo' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#catalogo">Catálogo</button>
    </li>
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'fornecedores' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#fornecedores">Fornecedores</button>
    </li>
    <li class="nav-item">
        <button
            class="nav-link border-0 rounded-top {% if active_tab == 'terceirizados' %}active bg-white shadow-sm fw-bold{% endif %}"
            data-bs-toggle="tab" data-bs-target="#terceirizados">Prestadores</button>
    </li>
</ul>

<div class="tab-content">

    <div class="tab-pane fade {% if active_tab == 'tecnicos' %}show active{% endif %}" id="tecnicos">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-bold text-primary">Novo Funcionário</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.novo_usuario') }}" method="POST">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" name="nome" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Login</label>
                            <input type="text" name="username" class="form-control" placeholder="Ex: joao.silva"
                                required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Senha</label>
                            <input type="password" name="senha" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cargo</label>
                            <select name="tipo" class="form-select" required>
                                <option value="tecnico">Técnico</option>
                                <option value="prestador">Prestador de Serviço</option>
                                <option value="gerente">Gerente de Unidade</option>
                                <option value="comprador">Comprador / Suprimentos</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="telefone" class="form-control" placeholder="(xx) xxxxx-xxxx">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Unidade Padrão</label>
                            <select name="unidade_id" class="form-select">
                                <option value="">Global / Todas</option>
                                {% for u in unidades %}<option value="{{ u.id }}">{{ u.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Salvar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-responsive-stack mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Nome</th>
                                <th>Login</th>
                                <th>Função</th>
                                <th>Contato</th>
                                <th>Unidade</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in funcionarios %}
                            <tr>
                                <td class="ps-4" data-label="Nome">{{ f.nome }}</td>
                                <td data-label="Login" class="fw-medium">{{ f.username }}</td>
                                <td data-label="Função">
                                    <span class="badge bg-secondary bg-opacity-10 text-dark border">{{ f.tipo|capitalize
                                        }}</span>
                                </td>
                                <td data-label="Contato" class="small text-muted">
                                    <div>{{ f.email or '-' }}</div>
                                    <div>{{ f.telefone or '' }}</div>
                                </td>
                                <td data-label="Unidade">{{ f.unidade_padrao_id or 'Global' }}</td>
                                <td data-label="Status">
                                    {% if f.ativo %}
                                    <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inativo</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4" data-label="Ações">
                                    <a href="{{ url_for('admin.toggle_usuario_status', id=f.id) }}"
                                        class="btn btn-sm btn-outline-{% if f.ativo %}warning{% else %}success{% endif %} me-1"
                                        title="{% if f.ativo %}Desativar{% else %}Ativar{% endif %} usuário">
                                        <i
                                            class="bi bi-{% if f.ativo %}pause-circle{% else %}play-circle{% endif %}"></i>
                                    </a>
                                    <a href="{{ url_for('admin.excluir_tecnico', id=f.id) }}"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Confirmar exclusão permanente?')"
                                        title="Excluir permanentemente">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'equipamentos' %}show active{% endif %}" id="equipamentos">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-bold text-primary">Novo Equipamento</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.novo_equipamento') }}" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Nome do Equipamento</label>
                        <input type="text" name="nome" class="form-control" placeholder="Ex: Esteira T50" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Categoria</label>
                        <select name="categoria" class="form-select" required>
                            <option value="cardio">Cardio</option>
                            <option value="musculacao">Musculação</option>
                            <option value="predial">Predial</option>
                            <option value="diversos">Diversos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unidade</label>
                        <select name="unidade_id" class="form-select" required>
                            {% for u in unidades %}<option value="{{ u.id }}">{{ u.nome }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-responsive-stack mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Nome</th>
                            <th>Categoria</th>
                            <th>Unidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in equipamentos %}
                        <tr>
                            <td class="ps-4" data-label="Nome fw-bold">{{ e.nome }}</td>
                            <td data-label="Categoria">{{ e.categoria|capitalize }}</td>
                            <td data-label="Unidade">{{ e.unidade.nome }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">Nenhum equipamento cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'unidades' %}show active{% endif %}" id="unidades">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-bold text-primary">Nova Unidade</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.nova_unidade') }}" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Nome da Unidade</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Endereço</label>
                        <input type="text" name="endereco" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Razão Social</label>
                        <input type="text" name="razao_social" class="form-control" placeholder="Empresa XYZ Ltda">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CNPJ</label>
                        <input type="text" name="cnpj" class="form-control" placeholder="00.000.000/0000-00">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Telefone</label>
                        <input type="text" name="telefone" class="form-control" placeholder="(11) 1234-5678">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">IP Permitido</label>
                        <input type="text" name="faixa_ip" class="form-control" placeholder="192.168..." required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Criar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-responsive-stack mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Nome</th>
                            <th>Endereço</th>
                            <th>Razão Social</th>
                            <th>CNPJ</th>
                            <th>Telefone</th>
                            <th>IPs Permitidos</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in unidades %}
                        <tr>
                            <td class="ps-4 fw-bold" data-label="Nome">{{ u.nome }}</td>
                            <td data-label="Endereço">{{ u.endereco or '-' }}</td>
                            <td data-label="Razão Social">{{ u.razao_social or '-' }}</td>
                            <td data-label="CNPJ">{{ u.cnpj or '-' }}</td>
                            <td data-label="Telefone">{{ u.telefone or '-' }}</td>
                            <td data-label="IPs"><code
                                    class="bg-light px-2 py-1 rounded text-dark">{{ u.faixa_ip_permitida }}</code></td>
                            <td class="text-end pe-4" data-label="Ações">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-sm btn-outline-secondary btn-editar-unidade"
                                        data-id="{{ u.id }}" data-nome="{{ u.nome }}"
                                        data-endereco="{{ u.endereco or '' }}" data-razao="{{ u.razao_social or '' }}"
                                        data-cnpj="{{ u.cnpj or '' }}" data-telefone="{{ u.telefone or '' }}"
                                        data-ip="{{ u.faixa_ip_permitida or '' }}" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <a href="{{ url_for('admin.excluir_unidade', id=u.id) }}"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Tem certeza que deseja excluir a unidade {{ u.nome }}?')"
                                        title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">Nenhuma unidade cadastrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'catalogo' %}show active{% endif %}" id="catalogo">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-bold text-primary">Nova Peça no Estoque</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.novo_item_estoque') }}" method="POST" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Código</label>
                        <input type="text" name="codigo" class="form-control" placeholder="ABC-123" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Nome da Peça</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Unidade</label>
                        <select name="unidade_medida" class="form-select">
                            <option value="UN">UN</option>
                            <option value="M">M</option>
                            <option value="KG">KG</option>
                            <option value="L">L</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Adicionar ao Catálogo</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-responsive-stack mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Código</th>
                            <th>Nome</th>
                            <th>Unidade</th>
                            <th>Saldo Atual</th>
                            <th>Mínimo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in estoque_itens %}
                        <tr>
                            <td class="ps-4 fw-bold" data-label="Código">{{ item.codigo }}</td>
                            <td data-label="Nome">{{ item.nome }}</td>
                            <td data-label="Unidade">{{ item.unidade_medida }}</td>
                            <td data-label="Saldo">{{ "{:g}".format(item.quantidade_atual) }}</td>
                            <td data-label="Mínimo">{{ "{:g}".format(item.quantidade_minima) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">Nenhum item no catálogo.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'fornecedores' %}show active{% endif %}" id="fornecedores">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold">Fornecedores Cadastrados</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovoFornecedor">
                <i class="bi bi-plus-lg me-2"></i> Novo Fornecedor
            </button>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-responsive-stack mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Fornecedor</th>
                            <th>Contato</th>
                            <th>Prazo Médio</th>
                            <th>Entregas</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in fornecedores %}
                        <tr>
                            <td class="ps-4 fw-bold" data-label="Fornecedor">{{ f.nome }}</td>
                            <td data-label="Contato">
                                <div class="small">{{ f.email }}</div>
                                <div class="small text-muted">{{ f.telefone }}</div>
                            </td>
                            <td data-label="Prazo">
                                <span class="badge bg-secondary bg-opacity-10 text-dark">{{
                                    "{:.0f}".format(f.prazo_medio_entrega_dias) }} dias</span>
                            </td>
                            <td data-label="Entregas">{{ f.total_pedidos_entregues }}</td>
                            <td class="text-end pe-4" data-label="Ações">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-sm btn-outline-primary btn-abrir-catalogo"
                                        data-id="{{ f.id }}" data-nome="{{ f.nome }}" title="Catálogo">
                                        <i class="bi bi-list-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary btn-editar-fornecedor"
                                        data-id="{{ f.id }}" data-nome="{{ f.nome }}" data-email="{{ f.email or '' }}"
                                        data-telefone="{{ f.telefone or '' }}" data-endereco="{{ f.endereco or '' }}"
                                        data-prazo="{{ f.prazo_medio_entrega_dias }}" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <a href="{{ url_for('admin.excluir_fornecedor', id=f.id) }}"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Tem certeza que deseja excluir o fornecedor {{ f.nome }}?')"
                                        title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">Nenhum fornecedor cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'terceirizados' %}show active{% endif %}" id="terceirizados">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-bold text-primary">Novo Prestador de Serviço</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.novo_terceirizado') }}" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Nome Contato</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nome Empresa</label>
                        <input type="text" name="nome_empresa" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Especialidades</label>
                        <input type="text" name="especialidades" class="form-control"
                            placeholder="Ex: Elétrica, Rede...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Telefone</label>
                        <input type="text" name="telefone" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Abrangência</label>
                        <select name="unidades" class="form-select" multiple size="3" style="font-size: 0.85rem;">
                            <option value="global" selected class="fw-bold">Global (Todas)</option>
                            {% for u in unidades %}
                            <option value="{{ u.id }}">{{ u.nome }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small">Segure Ctrl para selecionar várias.</div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-responsive-stack mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Empresa / Contato</th>
                            <th>Detalhes</th>
                            <th>Especialidades</th>
                            <th>Abrangência</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in terceirizados %}
                        <tr>
                            <td class="ps-4" data-label="Nome">
                                <div class="fw-bold">{{ t.nome }}</div>
                                <small class="text-muted">{{ t.nome_empresa or '' }}</small>
                            </td>
                            <td data-label="Detalhes">
                                <div class="small">{{ t.telefone }}</div>
                                <div class="small text-muted">{{ t.email or '' }}</div>
                            </td>
                            <td data-label="Especialidades">{{ t.especialidades or '-' }}</td>
                            <td data-label="Abrangência">
                                {% if t.abrangencia_global %}
                                <span class="badge bg-success bg-opacity-10 text-success">Global</span>
                                {% else %}
                                {% for u in t.unidades %}
                                <span class="badge bg-secondary bg-opacity-10 text-dark mb-1">{{ u.nome }}</span>
                                {% else %}
                                <span class="text-muted small">Nenhuma</span>
                                {% endfor %}
                                {% endif %}
                            </td>
                            <td class="text-end pe-4" data-label="Ações">
                                <button class="btn btn-sm btn-outline-primary btn-editar-terceirizado me-1"
                                    data-id="{{ t.id }}" data-nome="{{ t.nome }}"
                                    data-empresa="{{ t.nome_empresa or '' }}" data-cnpj="{{ t.cnpj or '' }}"
                                    data-telefone="{{ t.telefone or '' }}" data-email="{{ t.email or '' }}"
                                    data-especialidades="{{ t.especialidades or '' }}"
                                    data-global="{{ 'true' if t.abrangencia_global else 'false' }}"
                                    data-unidades='[{% for u in t.unidades %}"{{ u.id }}"{% if not loop.last %},{% endif %}{% endfor %}]'
                                    title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <a href="{{ url_for('admin.excluir_terceirizado', id=t.id) }}"
                                    class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">Nenhum prestador cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoFornecedor" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Novo Fornecedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.novo_fornecedor') }}" method="POST">
                <div class="modal-body pt-4">
                    <div class="mb-3">
                        <label class="form-label">Nome / Razão Social</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="col">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="telefone" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prazo Médio Inicial (Dias)</label>
                        <input type="number" name="prazo_inicial" class="form-control" value="7">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Endereço</label>
                        <input type="text" name="endereco" class="form-control">
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalGerenciarCatalogo" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloCatalogo">Gerenciar Catálogo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold mb-3">Peças Fornecidas</h6>
                <div class="table-responsive mb-4 border rounded">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Cód.</th>
                                <th>Peça</th>
                                <th>Preço (R$)</th>
                                <th>Prazo (Dias)</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPecasFornecedor">
                            <tr>
                                <td colspan="4" class="text-center py-3">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h6 class="fw-bold pt-3 border-top">Vincular Nova Peça</h6>
                <form action="{{ url_for('admin.vincular_peca_fornecedor') }}" method="POST">
                    <input type="hidden" name="fornecedor_id" id="inputFornecedorId">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label small text-muted">Peça</label>
                            <select name="estoque_id" class="form-select form-select-sm" required>
                                <option value="" selected disabled>Escolha...</option>
                                {% for item in estoque_itens %}
                                <option value="{{ item.id }}">{{ item.nome }} ({{ item.codigo }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Preço Atual</label>
                            <input type="number" step="0.01" name="preco" class="form-control form-control-sm"
                                placeholder="0.00">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Prazo</label>
                            <input type="number" name="prazo" class="form-control form-control-sm" placeholder="Dias">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">Vincular</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarTerceirizado" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Editar Prestador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.editar_terceirizado') }}" method="POST">
                <input type="hidden" name="id" id="editTercId">
                <div class="modal-body pt-4">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Nome Contato</label>
                            <input type="text" name="nome" id="editTercNome" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome Empresa</label>
                            <input type="text" name="nome_empresa" id="editTercEmpresa" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CNPJ</label>
                            <input type="text" name="cnpj" id="editTercCnpj" class="form-control"
                                placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Especialidades</label>
                            <input type="text" name="especialidades" id="editTercEspec" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="telefone" id="editTercTelefone" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" id="editTercEmail" class="form-control">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Abrangência</label>
                            <select name="unidades" id="editTercUnidades" class="form-select" multiple size="3">
                                <option value="global">Global (Todas)</option>
                                {% for u in unidades %}
                                <option value="{{ u.id }}">{{ u.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarFornecedor" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Editar Fornecedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.editar_fornecedor') }}" method="POST">
                <input type="hidden" name="id" id="editFornId">
                <div class="modal-body pt-4">
                    <div class="mb-3">
                        <label class="form-label">Nome / Razão Social</label>
                        <input type="text" name="nome" id="editFornNome" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" id="editFornEmail" class="form-control">
                        </div>
                        <div class="col">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="telefone" id="editFornTelefone" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prazo Médio (Dias)</label>
                        <input type="number" step="0.1" name="prazo_medio" id="editFornPrazo" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Endereço</label>
                        <input type="text" name="endereco" id="editFornEndereco" class="form-control">
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarUnidade" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Editar Unidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.editar_unidade') }}" method="POST">
                <input type="hidden" name="id" id="editUnidadeId">
                <div class="modal-body pt-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome da Unidade</label>
                            <input type="text" name="nome" id="editUnidadeNome" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Endereço</label>
                            <input type="text" name="endereco" id="editUnidadeEndereco" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Razão Social</label>
                            <input type="text" name="razao_social" id="editUnidadeRazao" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CNPJ</label>
                            <input type="text" name="cnpj" id="editUnidadeCnpj" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone</label>
                            <input type="text" name="telefone" id="editUnidadeTelefone" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">IP Permitido</label>
                            <input type="text" name="faixa_ip" id="editUnidadeIp" class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function abrirCatalogo(id, nome) {
        // Definir o ID do fornecedor no formulário de vincular peça
        document.getElementById('inputFornecedorId').value = id;

        // Atualizar título do modal
        document.getElementById('tituloCatalogo').textContent = 'Catálogo - ' + nome;

        // Mostrar loading na tabela
        const tabela = document.getElementById('tabelaPecasFornecedor');
        tabela.innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Carregando...</td></tr>';

        // Abrir o modal
        const modal = new bootstrap.Modal(document.getElementById('modalGerenciarCatalogo'));
        modal.show();

        // Buscar peças do fornecedor via API
        fetch('/admin/api/fornecedores/' + id + '/pecas')
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    tabela.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">Nenhuma peça vinculada a este fornecedor.</td></tr>';
                } else {
                    let html = '';
                    data.forEach((item, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.nome}</td>
                                <td>R$ ${parseFloat(item.preco).toFixed(2).replace('.', ',')}</td>
                                <td>${item.prazo} dias</td>
                            </tr>
                        `;
                    });
                    tabela.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Erro ao buscar peças:', error);
                tabela.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-danger">Erro ao carregar peças.</td></tr>';
            });
    }

    function editarTerceirizado(id, nome, empresa, cnpj, telefone, email, especialidades, global, unidades) {
        document.getElementById('editTercId').value = id;
        document.getElementById('editTercNome').value = nome;
        document.getElementById('editTercEmpresa').value = empresa;
        document.getElementById('editTercCnpj').value = cnpj;
        document.getElementById('editTercTelefone').value = telefone;
        document.getElementById('editTercEmail').value = email;
        document.getElementById('editTercEspec').value = especialidades;

        const select = document.getElementById('editTercUnidades');
        Array.from(select.options).forEach(opt => {
            opt.selected = false;
            if (global && opt.value === 'global') opt.selected = true;
            if (unidades.includes(opt.value)) opt.selected = true;
        });

        new bootstrap.Modal(document.getElementById('modalEditarTerceirizado')).show();
    }

    function editarFornecedor(id, nome, email, telefone, endereco, prazo) {
        document.getElementById('editFornId').value = id;
        document.getElementById('editFornNome').value = nome;
        document.getElementById('editFornEmail').value = email;
        document.getElementById('editFornTelefone').value = telefone;
        document.getElementById('editFornEndereco').value = endereco;
        document.getElementById('editFornPrazo').value = prazo;

        new bootstrap.Modal(document.getElementById('modalEditarFornecedor')).show();
    }

    function editarUnidade(id, nome, endereco, razao, cnpj, telefone, ip) {
        document.getElementById('editUnidadeId').value = id;
        document.getElementById('editUnidadeNome').value = nome;
        document.getElementById('editUnidadeEndereco').value = endereco;
        document.getElementById('editUnidadeRazao').value = razao;
        document.getElementById('editUnidadeCnpj').value = cnpj;
        document.getElementById('editUnidadeTelefone').value = telefone;
        document.getElementById('editUnidadeIp').value = ip;

        new bootstrap.Modal(document.getElementById('modalEditarUnidade')).show();
    }

    // Auto-dismiss alerts após 5 segundos
    document.addEventListener('DOMContentLoaded', function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });

        // Listener para Editar Unidade
        document.querySelectorAll('.btn-editar-unidade').forEach(btn => {
            btn.addEventListener('click', function () {
                const d = this.dataset;
                editarUnidade(d.id, d.nome, d.endereco, d.razao, d.cnpj, d.telefone, d.ip);
            });
        });

        // Listener para Editar Prestador (Terceirizado)
        document.querySelectorAll('.btn-editar-terceirizado').forEach(btn => {
            btn.addEventListener('click', function () {
                const d = this.dataset;
                const unidades = JSON.parse(d.unidades || '[]');
                editarTerceirizado(d.id, d.nome, d.empresa, d.cnpj, d.telefone, d.email, d.especialidades, d.global === 'true', unidades);
            });
        });

        // Listener para Abrir Catálogo
        document.querySelectorAll('.btn-abrir-catalogo').forEach(btn => {
            btn.addEventListener('click', function () {
                abrirCatalogo(this.dataset.id, this.dataset.nome);
            });
        });

        // Listener para Editar Fornecedor
        document.querySelectorAll('.btn-editar-fornecedor').forEach(btn => {
            btn.addEventListener('click', function () {
                const d = this.dataset;
                editarFornecedor(d.id, d.nome, d.email, d.telefone, d.endereco, d.prazo);
            });
        });
    });
</script>
{% endblock %}