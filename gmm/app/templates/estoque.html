{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('ponto.index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Controle de Estoque</li>
{% endblock %}

{% block content %}
<div class="mb-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div>
        <nav aria-label="breadcrumb" class="mb-1">
            <ol class="breadcrumb mb-0" style="font-size: 0.75rem;">
                <li class="breadcrumb-item"><a href="{{ url_for('ponto.index') }}"
                        class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item active">Controle de Estoque</li>
            </ol>
        </nav>
        <h2 class="mb-0 fw-bold">Estoque</h2>
        <p class="mb-0 text-muted small">Gerenciamento centralizado de pe√ßas e insumos.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-secondary" onclick="abrirHistorico()">
            <i class="bi bi-clock-history"></i> Hist√≥rico
        </button>
        <button class="btn btn-primary" onclick="abrirModalEntrada()">
            <i class="bi bi-plus-lg"></i> Nova Entrada
        </button>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-responsive-stack mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Item / C√≥digo</th>
                        <th>Categoria</th>
                        <th>Saldo</th>
                        <th>Valor Unit.</th>
                        <th>Status</th>
                        <th class="text-end pe-4">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in estoque %}
                    <tr
                        class="{% if item.quantidade_atual <= item.quantidade_minima %}table-danger bg-opacity-10{% endif %}">
                        <td class="ps-4" data-label="Item">
                            <div class="fw-bold text-dark">{{ item.nome }}</div>
                            <small class="text-muted font-monospace bg-light px-2 py-1 rounded border">{{ item.codigo
                                }}</small>
                        </td>
                        <td data-label="Categoria">
                            <span
                                class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-10">
                                {{ item.categoria.nome if item.categoria else 'Geral' }}
                            </span>
                        </td>
                        <td data-label="Saldo">
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold fs-6 text-primary">{{ "{:g}".format(item.quantidade_atual|float)
                                    }}</span>
                                <span class="text-muted small">{{ item.unidade_medida }}</span>
                            </div>

                            {% if item.saldos %}
                            <div class="mt-2 pt-2 border-top border-light">
                                <div class="small fw-bold text-muted mb-1"
                                    style="font-size: 0.65rem; text-transform: uppercase;">Por Unidade:</div>
                                <ul class="list-unstyled mb-0 d-flex flex-wrap gap-x-3 gap-y-1"
                                    style="font-size: 0.7rem;">
                                    {% for s in item.saldos %}
                                    <li class="text-nowrap">
                                        <span class="text-muted">{{ s.unidade.nome }}:</span>
                                        <span class="fw-bold {{ 'text-danger' if s.quantidade < 0 else 'text-dark' }}">
                                            {{ "{:g}".format(s.quantidade|float) }}
                                        </span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </td>
                        <td data-label="Valor Unit.">
                            <span class="text-muted">R$ {{ "{:.2f}".format(item.valor_unitario or 0) }}</span>
                        </td>
                        <td data-label="Status">
                            {% if item.quantidade_atual <= item.quantidade_minima %} <div
                                class="d-flex align-items-center gap-2">
                                <span class="badge bg-danger text-white shadow-sm shimmer">BAIXO</span>
                                <button class="btn btn-xs btn-danger btn-sm-custom ms-2 fade-in"
                                    onclick="solicitarCompraItem('{{ item.id }}', '{{ item.nome }}', '{{ item.quantidade_minima }}')">
                                    üõí Comprar
                                </button>
        </div>
        {% else %}
        <span class="badge bg-success bg-opacity-10 text-success">
            <i class="bi bi-check2"></i> Normal
        </span>
        {% endif %}
        </td>
        <td class="text-end pe-4" data-label="A√ß√µes">
            <div class="dropdown d-inline-block">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                    data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                    <li>
                        <button class="dropdown-item"
                            onclick="abrirModalTransferencia('{{ item.id }}', '{{ item.nome }}')">
                            <i class="bi bi-arrow-left-right me-2 text-primary"></i> Transferir
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item"
                            onclick="ajusteRapido('{{ item.id }}', '{{ item.nome }}', '{{ item.valor_unitario }}')">
                            <i class="bi bi-sliders me-2"></i> Ajuste R√°pido
                        </button>
                    </li>
                </ul>
            </div>
        </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" class="text-center py-5">
                <div class="text-muted opacity-50">
                    <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                    Nenhum item no estoque.
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
        </table>
    </div>
</div>
</div>

<div class="modal fade" id="modalDistribuicao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Distribui√ß√£o de Estoque</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <h6 id="distItemNome" class="text-primary fw-bold mb-3"></h6>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th>Unidade</th>
                                <th class="text-end">Saldo</th>
                                <th class="text-end">Localiza√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="distTabelaCorpo">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-end">
                    <small class="text-muted">Total Global: <span id="distTotalGlobal" class="fw-bold"></span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEntrada" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="entradaModalTitle">Nova Entrada de Estoque</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="formEntrada" onsubmit="event.preventDefault(); salvarEntrada();">

                    <div class="mb-3" id="divSelectPeca">
                        <label class="form-label">Buscar Item</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="buscaPecaInput"
                                placeholder="Digite para buscar..." autocomplete="off">
                            <input type="hidden" id="pecaIdSelecionada">
                            <div id="listaSugestoes" class="list-group position-absolute w-100 shadow-sm"
                                style="z-index: 1000; display: none;"></div>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="divItemFixo">
                        <label class="form-label">Item Selecionado</label>
                        <input type="text" class="form-control bg-light" id="nomeItemFixo" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Unidade (Destino)</label>
                        <select id="unidadeEntrada" class="form-select" required>
                            {% for u in unidades %}
                            <option value="{{ u.id }}">{{ u.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">Quantidade</label>
                            <input type="number" step="0.01" class="form-control" id="qtdEntrada" required>
                            <div class="form-text x-small">Use valores negativos (ex: -5) para furto, dano ou perda.
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Valor Unit. (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="valorEntrada">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Motivo / Obs</label>
                        <input type="text" class="form-control" id="motivoEntrada" placeholder="Ex: Nota Fiscal 1234">
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-success" id="btnSalvarEntrada">
                            Confirmar Entrada
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSolicitarCompra" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Solicitar Compra de Pe√ßa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <div class="mb-3">
                    <label class="form-label">Item</label>
                    <input type="text" class="form-control bg-light" id="compraNomeItem" readonly>
                    <input type="hidden" id="compraIdItem">
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantidade para Reposi√ß√£o</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" id="compraQtd" required>
                </div>
                <div class="d-grid mt-4">
                    <button type="button" onclick="confirmarSolicitacaoCompra()" class="btn btn-danger"
                        id="btnConfirmarCompra">
                        Confirmar Solicita√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSolicitarCompraGeral" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Nova Solicita√ß√£o de Compra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <div class="mb-3 position-relative">
                    <label class="form-label">Buscar Item</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0" id="buscaPecaCompraGeral"
                            placeholder="Digite o nome da pe√ßa...">
                    </div>
                    <div id="sugestoesCompraGeral" class="list-group position-absolute w-100 shadow-sm"
                        style="display: none; z-index: 1055;"></div>
                    <input type="hidden" id="pecaIdCompraGeral">
                </div>
                <div class="mb-4">
                    <label class="form-label">Quantidade para Reposi√ß√£o</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" id="qtdCompraGeral" required>
                </div>
                <div class="d-grid mt-4">
                    <button type="button" onclick="confirmarSolicitacaoCompraGeral()"
                        class="btn btn-danger py-2 fw-bold" id="btnConfirmarCompraGeral">
                        <i class="bi bi-cart-plus me-2"></i> Solicitar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalTransferencia" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Transferir Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="formTransferencia" onsubmit="event.preventDefault(); salvarTransferencia();">
                    <input type="hidden" id="transfEstoqueId">

                    <div class="mb-3">
                        <label class="form-label">Item</label>
                        <input type="text" class="form-control bg-light" id="transfNomeItem" readonly>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label">Origem</label>
                            <select id="transfOrigem" class="form-select" required>
                                <option value="" disabled selected>De...</option>
                                {% for u in unidades %}
                                <option value="{{ u.id }}">{{ u.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Destino</label>
                            <select id="transfDestino" class="form-select" required>
                                <option value="" disabled selected>Para...</option>
                                {% for u in unidades %}
                                <option value="{{ u.id }}">{{ u.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" step="0.01" class="form-control" id="transfQtd" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observa√ß√£o</label>
                        <input type="text" class="form-control" id="transfObs">
                    </div>

                    <div class="alert alert-info py-2 small border-0 mb-3" id="transfInfoText">
                        {% if current_user.tipo in ['admin', 'gerente'] %}
                        <i class="bi bi-lightning-fill me-1"></i> Ser√° executado imediatamente
                        {% else %}
                        <i class="bi bi-hourglass-split me-1"></i> Ser√° enviado para aprova√ß√£o
                        {% endif %}
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary" id="btnSalvarTransf">
                            {% if current_user.tipo in ['admin', 'gerente'] %}
                            Executar Transfer√™ncia
                            {% else %}
                            Solicitar Transfer√™ncia
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistorico" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Hist√≥rico de Movimenta√ß√µes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <div class="table-responsive">
                    <table class="table table-sm align-middle small">
                        <thead class="bg-light">
                            <tr>
                                <th>Data</th>
                                <th>Item</th>
                                <th>Tipo</th>
                                <th>Qtd</th>
                                <th>Unidade</th>
                                <th>Usu√°rio</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="histTabelaCorpo">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .saldo-local {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .saldo-local .fw-bold {
        color: var(--primary);
    }

    .btn-icon:hover {
        background-color: var(--primary-light);
    }

    .shimmer {
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    .btn-sm-custom {
        padding: 0.1rem 0.4rem;
        font-size: 0.75rem;
    }

    .table-danger {
        background-color: #fff5f5 !important;
    }
</style>

<script>
    let modalEntrada;
    let modalTransferencia;
    let modalHistorico;
    let modalCompraGeral;
    let buscaInput;
    let sugestoesDiv;
    let debounceTimer;

    document.addEventListener('DOMContentLoaded', () => {
        modalEntrada = new bootstrap.Modal(document.getElementById('modalEntrada'));
        modalTransferencia = new bootstrap.Modal(document.getElementById('modalTransferencia'));
        modalHistorico = new bootstrap.Modal(document.getElementById('modalHistorico'));
        modalCompraGeral = new bootstrap.Modal(document.getElementById('modalSolicitarCompraGeral'));

        buscaInput = document.getElementById('buscaPecaInput');
        sugestoesDiv = document.getElementById('listaSugestoes');

        initBuscaInput();
        initBuscaGeral();
    });

    function abrirModalEntrada() {
        document.getElementById('entradaModalTitle').innerText = "Nova Entrada (Manual)";
        document.getElementById('divSelectPeca').classList.remove('d-none');
        document.getElementById('divItemFixo').classList.add('d-none');
        document.getElementById('formEntrada').reset();
        document.getElementById('pecaIdSelecionada').value = "";
        modalEntrada.show();
        setTimeout(() => buscaInput.focus(), 500);
    }

    function abrirModalTransferencia(id, nome) {
        document.getElementById('transfEstoqueId').value = id;
        document.getElementById('transfNomeItem').value = nome;
        document.getElementById('formTransferencia').reset();
        modalTransferencia.show();
    }

    function salvarTransferencia() {
        const id = document.getElementById('transfEstoqueId').value;
        const origem = document.getElementById('transfOrigem').value;
        const destino = document.getElementById('transfDestino').value;
        const qtd = document.getElementById('transfQtd').value;
        const obs = document.getElementById('transfObs').value;

        if (origem === destino) {
            ToastModule.show("Origem e Destino devem ser diferentes.", "warning");
            return;
        }

        const btn = document.getElementById('btnSalvarTransf');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';

        fetch('/os/api/estoque/transferir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                estoque_id: id,
                unidade_origem_id: origem,
                unidade_destino_id: destino,
                quantidade: qtd,
                observacao: obs
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    ToastModule.show(data.msg, "success");
                    modalTransferencia.hide();
                } else {
                    ToastModule.show("Erro: " + data.erro, "danger");
                }
            })
            .catch(() => ToastModule.show("Erro de conex√£o", "danger"))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    function ajusteRapido(id, nome, valorAtual) {
        document.getElementById('entradaModalTitle').innerText = "Ajuste R√°pido de Estoque";
        document.getElementById('divSelectPeca').classList.add('d-none');
        document.getElementById('divItemFixo').classList.remove('d-none');
        // ... (rest of function remains same)
        document.getElementById('nomeItemFixo').value = nome;
        document.getElementById('pecaIdSelecionada').value = id;
        document.getElementById('valorEntrada').value = valorAtual;
        document.getElementById('qtdEntrada').value = "";
        document.getElementById('motivoEntrada').value = "Ajuste de Invent√°rio";
        modalEntrada.show();
    }

    // Busca de Pe√ßas
    function initBuscaInput() {
        buscaInput.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const termo = this.value;
            if (termo.length < 2) {
                sugestoesDiv.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`/os/api/pecas/buscar?q=${termo}`)
                    .then(r => r.json())
                    .then(data => {
                        sugestoesDiv.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('a');
                                div.className = 'list-group-item list-group-item-action cursor-pointer';
                                div.innerHTML = `<strong>${item.nome}</strong> <span class="text-muted small">(${item.saldo} ${item.unidade})</span>`;
                                div.onclick = () => selecionarPeca(item);
                                sugestoesDiv.appendChild(div);
                            });
                            sugestoesDiv.style.display = 'block';
                        } else {
                            sugestoesDiv.style.display = 'none';
                        }
                    });
            }, 300);
        });
    }

    function selecionarPeca(item) {
        buscaInput.value = item.nome;
        document.getElementById('pecaIdSelecionada').value = item.id;
        document.getElementById('valorEntrada').value = ""; // Pode puxar do item se quiser
        sugestoesDiv.style.display = 'none';
    }

    function salvarEntrada() {
        const id = document.getElementById('pecaIdSelecionada').value;
        const qtd = document.getElementById('qtdEntrada').value;
        const valor = document.getElementById('valorEntrada').value;
        const motivo = document.getElementById('motivoEntrada').value;

        // [NOVO]
        const unidade = document.getElementById('unidadeEntrada').value;

        if (!id || !qtd) {
            ToastModule.show("Selecione um item e informe a quantidade.", "warning");
            return;
        }

        const btn = document.getElementById('btnSalvarEntrada');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';

        fetch('/os/api/estoque/entrada', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                estoque_id: id,
                quantidade: parseFloat(qtd),
                motivo: motivo,
                valor_novo: valor ? parseFloat(valor) : null,
                unidade_id: unidade // [NOVO]
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    ToastModule.show("Entrada registrada com sucesso!", "success");
                    modalEntrada.hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    ToastModule.show("Erro: " + data.erro, "danger");
                }
            })
            .catch(err => ToastModule.show("Erro ao conectar.", "danger"))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    function solicitarCompraItem(id, nome, qtdMinima = 5) {
        document.getElementById('compraIdItem').value = id;
        document.getElementById('compraNomeItem').value = nome;
        document.getElementById('compraQtd').value = qtdMinima;

        new bootstrap.Modal(document.getElementById('modalSolicitarCompra')).show();
    }

    async function confirmarSolicitacaoCompra() {
        const id = document.getElementById('compraIdItem').value;
        const qtd = document.getElementById('compraQtd').value;
        const btn = document.getElementById('btnConfirmarCompra');

        if (!qtd || qtd <= 0) {
            ToastModule.show("Informe uma quantidade v√°lida.", "warning");
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Solicitando...';

        try {
            const res = await fetch(`/os/api/estoque/solicitar-compra`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estoque_id: id, quantidade: qtd })
            });
            const data = await res.json();

            if (data.success) {
                ToastModule.show(data.mensagem || "Solicita√ß√£o enviada!", "success");
                bootstrap.Modal.getInstance(document.getElementById('modalSolicitarCompra')).hide();
                // A p√°gina ser√° recarregada para mostrar o pedido? O PRD n√£o pede explicitamente,
                // mas √© boa pr√°tica. Aqui vou apenas fechar e talvez atualizar o status se houvesse UI para isso.
            } else {
                ToastModule.show("Erro: " + data.erro, "danger");
            }
        } catch (e) {
            ToastModule.show("Erro de conex√£o.", "danger");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }



    function abrirModalCompraGeral() {
        document.getElementById('pecaIdCompraGeral').value = '';
        document.getElementById('buscaPecaCompraGeral').value = '';
        document.getElementById('qtdCompraGeral').value = '';
        document.getElementById('sugestoesCompraGeral').style.display = 'none';
        modalCompraGeral.show();
    }

    function initBuscaGeral() {
        const buscaGeralInput = document.getElementById('buscaPecaCompraGeral');
        const sugestoesGeralDiv = document.getElementById('sugestoesCompraGeral');

        if (!buscaGeralInput) return;

        buscaGeralInput.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const termo = this.value;
            if (termo.length < 2) {
                sugestoesGeralDiv.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`/os/api/pecas/buscar?q=${termo}`)
                    .then(r => r.json())
                    .then(data => {
                        sugestoesGeralDiv.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('a');
                                div.className = 'list-group-item list-group-item-action cursor-pointer';
                                div.innerHTML = `<strong>${item.nome}</strong> <span class="text-muted small">(${item.saldo} ${item.unidade})</span>`;
                                div.onclick = () => {
                                    buscaGeralInput.value = item.nome;
                                    document.getElementById('pecaIdCompraGeral').value = item.id;
                                    sugestoesGeralDiv.style.display = 'none';
                                };
                                sugestoesGeralDiv.appendChild(div);
                            });
                            sugestoesGeralDiv.style.display = 'block';
                        } else {
                            sugestoesGeralDiv.style.display = 'none';
                        }
                    });
            }, 300);
        });
    }

    async function confirmarSolicitacaoCompraGeral() {
        const id = document.getElementById('pecaIdCompraGeral').value;
        const qtd = document.getElementById('qtdCompraGeral').value;
        const btn = document.getElementById('btnConfirmarCompraGeral');

        if (!id) {
            ToastModule.show("Selecione um item da lista.", "warning");
            return;
        }

        if (!qtd || qtd <= 0) {
            ToastModule.show("Informe uma quantidade v√°lida.", "warning");
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Solicitando...';

        try {
            const res = await fetch('/os/api/estoque/solicitar-compra', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    estoque_id: id,
                    quantidade: parseFloat(qtd)
                })
            });
            const data = await res.json();
            if (data.success) {
                ToastModule.show("Solicita√ß√£o de compra enviada!", "success");
                modalCompraGeral.hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                ToastModule.show("Erro: " + data.erro, "danger");
            }
        } catch (e) {
            ToastModule.show("Erro ao conectar.", "danger");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function abrirHistorico() {
        const corpo = document.getElementById('histTabelaCorpo');
        corpo.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';

        modalHistorico.show();

        try {
            const res = await fetch('/os/api/estoque/historico');
            const data = await res.json();

            corpo.innerHTML = '';
            if (data.length > 0) {
                data.forEach(m => {
                    const tr = document.createElement('tr');
                    const corTipo = m.tipo.toLowerCase() === 'entrada' ? 'text-success' : 'text-danger';
                    tr.innerHTML = `
                        <td class="text-muted">${m.data}</td>
                        <td class="fw-bold">${m.item}</td>
                        <td class="${corTipo}">${m.tipo}</td>
                        <td class="fw-bold">${m.qtd}</td>
                        <td>${m.unidade}</td>
                        <td class="text-muted">${m.usuario}</td>
                    `;
                    corpo.appendChild(tr);
                });
            } else {
                corpo.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Nenhuma movimenta√ß√£o recente.</td></tr>';
            }
        } catch (e) {
            corpo.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Erro ao carregar hist√≥rico.</td></tr>';
        }
    }

    async function verDistribuicao(id, nome) {
        const nomeEl = document.getElementById('distItemNome');
        const corpo = document.getElementById('distTabelaCorpo');
        const total = document.getElementById('distTotalGlobal');

        nomeEl.innerText = nome;
        corpo.innerHTML = '<tr><td colspan="3" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';
        total.innerText = '...';

        const modal = new bootstrap.Modal(document.getElementById('modalDistribuicao'));
        modal.show();

        try {
            const res = await fetch(`/os/api/estoque/${id}/disponibilidade`);
            const data = await res.json();

            corpo.innerHTML = '';
            if (data.distribuicao && data.distribuicao.length > 0) {
                data.distribuicao.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${d.unidade_nome}</td>
                        <td class="text-end fw-bold">${d.saldo} ${data.unidade_medida}</td>
                        <td class="text-end text-muted small">${d.localizacao}</td>
                    `;
                    corpo.appendChild(tr);
                });
            } else {
                corpo.innerHTML = '<tr><td colspan="2" class="text-center py-3 text-muted">Sem saldo em nenhuma unidade.</td></tr>';
            }
            total.innerText = `${data.saldo_global} ${data.unidade_medida}`;
        } catch (e) {
            corpo.innerHTML = '<tr><td colspan="3" class="text-center py-3 text-danger">Erro ao carregar distribui√ß√£o.</td></tr>';
        }
    }

    // Fecha sugest√µes ao clicar fora
    document.addEventListener('click', function (e) {
        if (e.target !== buscaInput) {
            sugestoesDiv.style.display = 'none';
        }
    });
</script>
{% endblock %}