{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <nav aria-label="breadcrumb" class="mb-1">
                <ol class="breadcrumb mb-0" style="font-size: 0.75rem;">
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </nav>
            <h2 class="mb-0 fw-bold text-dark">Área do Técnico</h2>
            <p class="text-muted small mb-0">Olá, {{ current_user.nome }}. Gerencie seus chamados e ponto eletrônico.
            </p>
        </div>
    </div>
</div>

<div class="d-flex gap-2 mb-4 overflow-auto pb-2">
    <a href="{{ url_for('os.nova_os') }}" class="btn btn-primary shadow-sm text-nowrap">
        <i class="bi bi-plus-lg me-2"></i>Nova OS
    </a>
    <button class="btn btn-white border shadow-sm text-nowrap bg-white" onclick="SearchModule.open()">
        <i class="bi bi-search me-2 text-muted"></i>Buscar Peça/Ativo
    </button>
    <a href="{{ url_for('terceirizados.listar_chamados') }}"
        class="btn btn-white border shadow-sm text-nowrap bg-white">
        <i class="bi bi-whatsapp me-2 text-success"></i>Abrir Chamado Externo
    </a>
    <a href="{{ url_for('os.painel_estoque') }}" class="btn btn-white border shadow-sm text-nowrap bg-white">
        <i class="bi bi-box-arrow-in-down me-2 text-muted"></i>Solicitar Material
    </a>
</div>
<div class="row g-4">
    <div class="col-lg-3">
        {% if current_user.tipo == 'tecnico' %}
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                <div class="mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center"
                        style="width: 64px; height: 64px;">
                        <i class="bi bi-stopwatch fs-2"></i>
                    </div>
                </div>
                <h5 class="fw-bold mb-1">Meu Ponto</h5>

                {% if registro_aberto %}
                <span class="badge bg-success bg-opacity-10 text-success align-self-center mb-3">Em
                    Expediente</span>
                <p class="text-muted small mb-4">Entrada registrada às {{
                    registro_aberto.data_hora_entrada.strftime('%H:%M') }}</p>
                <form action="{{ url_for('ponto.checkout') }}" method="POST">
                    <input type="hidden" name="registro_id" value="{{ registro_aberto.id }}">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-box-arrow-right"></i> Registrar Saída
                    </button>
                </form>
                {% else %}
                <span class="badge bg-secondary align-self-center mb-3">Não Iniciado</span>
                <form action="{{ url_for('ponto.checkin') }}" method="POST" id="formCheckin">
                    <input type="hidden" name="latitude" id="lat">
                    <input type="hidden" name="longitude" id="lon">
                    <select name="unidade_id" class="form-select mb-3" required>
                        <option value="" selected disabled>Selecionar Local</option>
                        {% for u in unidades %}
                        <option value="{{ u.id }}">{{ u.nome }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="getLocationAndSubmit()" class="btn btn-primary w-100">
                        <i class="bi bi-geo-alt me-2"></i> Check-in
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('os.nova_os') }}"
            class="btn btn-primary btn-lg rounded-circle shadow-lg position-fixed bottom-0 end-0 m-3 d-lg-none"
            style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; z-index: 100;">
            <i class="bi bi-plus-lg fs-4"></i>
        </a>

        <div class="d-none d-lg-block mt-4">
            <a href="{{ url_for('os.nova_os') }}" class="btn btn-primary w-100 py-3 mb-3 shadow-sm">
                <i class="bi bi-plus-lg me-2"></i> Nova OS
            </a>

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold text-uppercase">Pendências</small>
                        <span class="badge bg-warning text-dark">{{ minhas_os | selectattr("status", "equalto",
                            "aberta") | list | length }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" style="width: 70%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">

        <!-- Centro de Notificações / Alertas (Só Exibe se houver dados) -->
        {% if alertas_os or alertas_estoque %}
        <div class="mb-5 fade-in">
            <h5 class="fw-bold mb-3 text-dark d-flex align-items-center gap-2">
                <i class="bi bi-bell-fill text-warning"></i>
                <span class="d-none d-md-inline">Atenção Necessária</span>
                <span class="badge bg-danger rounded-pill ms-auto ms-md-2 fs-6">
                    {{ (alertas_os|length) + (alertas_estoque|length) }}
                </span>
            </h5>

            <div class="row g-3">
                <!-- Alertas de OS -->
                {% for a in alertas_os %}
                <div class="col-md-6 col-xl-4">
                    <div
                        class="card border-0 shadow-sm border-start border-4 border-danger h-100 position-relative hover-shadow transition-all">
                        <div class="card-body p-3 d-flex align-items-start gap-3">
                            <div class="bg-danger bg-opacity-10 text-danger rounded p-2">
                                <i class="bi bi-clock-history fs-5"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark">OS #{{ a.numero_os }}</h6>
                                <p class="text-danger small mb-0 fw-medium">
                                    Vence: {{ a.prazo_conclusao.strftime('%d/%m %H:%M') }}
                                </p>
                                <a href="{{ url_for('os.detalhes', id=a.id) }}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Alertas de Estoque -->
                {% for e in alertas_estoque %}
                <div class="col-md-6 col-xl-4">
                    <div
                        class="card border-0 shadow-sm border-start border-4 border-warning h-100 position-relative hover-shadow transition-all">
                        <div class="card-body p-3 d-flex align-items-start gap-3">
                            <div class="bg-warning bg-opacity-10 text-warning rounded p-2">
                                <i class="bi bi-box-seam fs-5"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark">Estoque Baixo</h6>
                                <p class="text-muted small mb-0">
                                    {{ e.nome }} ({{ "{:g}".format(e.quantidade_atual) }} unid)
                                </p>
                                <a href="{{ url_for('os.painel_estoque') }}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4" id="minhas-os">
            <h3 class="mb-0">Ordens de Serviço</h3>
            <div class="d-flex gap-2 align-items-center flex-wrap">
                <select class="form-select form-select-sm shadow-sm" id="unidadeFiltro" onchange="aplicarFiltros()"
                    style="width: auto; min-width: 150px;">
                    <option value="">Todas Unidades</option>
                    {% for u in unidades %}
                    <option value="{{ u.id }}" {% if request.args.get('unidade_id')|int == u.id %}selected{% endif %}>
                        {{ u.nome }}
                    </option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm shadow-sm" id="tipoFiltro" onchange="aplicarFiltros()"
                    style="width: auto; min-width: 150px;">
                    <option value="">Todos os Tipos</option>
                    <option value="preventiva" {% if request.args.get('tipo') == 'preventiva' %}selected{% endif %}>Manutenção Preventiva</option>
                    <option value="corretiva" {% if request.args.get('tipo') == 'corretiva' %}selected{% endif %}>Corretiva/Outros</option>
                </select>
                <select class="form-select form-select-sm shadow-sm" id="statusFiltro" onchange="aplicarFiltros()"
                    style="width: auto; min-width: 130px;">
                    <option value="aberta" {% if not request.args.get('status') or request.args.get('status') == 'aberta' %}selected{% endif %}>Apenas Abertas</option>
                    <option value="concluida" {% if request.args.get('status') == 'concluida' %}selected{% endif %}>Apenas Concluídas</option>
                    <option value="todas" {% if request.args.get('status') == 'todas' %}selected{% endif %}>Todas</option>
                </select>
                <select class="form-select form-select-sm shadow-sm" id="sortSelect" onchange="sortOSList()"
                    style="width: auto;">
                    <option value="data-desc">Mais Recentes</option>
                    <option value="data-asc">Mais Antigas</option>
                    <option value="prioridade-desc">Prioridade Alta</option>
                    <option value="status-asc">Status (Abertas)</option>
                </select>
                <div class="d-none d-md-block" style="width: 200px;">
                    <input type="text" class="form-control form-control-sm shadow-sm" placeholder="Buscar..."
                        onkeyup="filterOSList(this.value)">
                </div>
            </div>
        </div>

        <table class="table table-responsive-stack table-hover">
            <thead>
                <tr>
                    <th style="width: 10%;">ID</th>
                    <th style="width: 30%;">Equipamento / Local</th>
                    <th style="width: 15%;">Prioridade</th>
                    <th style="width: 15%;">Status</th>
                    <th style="width: 20%;" class="text-end">Ação</th>
                </tr>
            </thead>
            <tbody id="osTableBody">
                {% for os in minhas_os %}
                <tr class="os-row" data-numero="{{ os.numero_os }}"
                    data-prioridade="{% if os.prioridade == 'urgente' %}3{% elif os.prioridade == 'alta' %}2{% else %}1{% endif %}"
                    data-status="{% if os.status == 'aberta' %}1{% else %}2{% endif %}"
                    data-data="{{ os.data_abertura.isoformat() }}">
                    <td data-label="OS ID">
                        <span class="fw-bold text-primary">#{{ os.numero_os }}</span>
                        {% if os.tipo_manutencao == 'preventiva' %}
                        <span class="badge bg-info bg-opacity-10 text-info ms-1" title="Manutenção Preventiva">
                            <i class="bi bi-calendar-check"></i>
                        </span>
                        {% endif %}
                    </td>
                    <td data-label="Equipamento">
                        <div class="fw-600">{{ os.equipamento_rel.nome if os.equipamento_rel else 'Geral' }}</div>
                        <small class="text-muted">{{ os.unidade.nome }}</small>
                    </td>
                    <td data-label="Prioridade">
                        {% if os.prioridade == 'urgente' %}
                        <span class="badge bg-danger bg-opacity-10 text-danger"><i class="bi bi-fire me-1"></i>
                            Urgente</span>
                        {% elif os.prioridade == 'alta' %}
                        <span class="badge bg-warning bg-opacity-10 text-warning">Alta</span>
                        {% else %}
                        <span class="badge bg-info bg-opacity-10 text-info">Normal</span>
                        {% endif %}
                    </td>
                    <td data-label="Status">
                        {% if os.status == 'aberta' %}
                        <span class="badge bg-warning text-dark">Aberta</span>
                        {% else %}
                        <span class="badge bg-success">Concluída</span>
                        {% endif %}
                    </td>
                    <td data-label="Ação">
                        <a href="{{ url_for('os.detalhes', id=os.id) }}"
                            class="btn btn-sm btn-outline-primary w-100-mobile">
                            Detalhes
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="text-muted d-flex flex-column align-items-center">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <span>Nenhuma ordem de serviço encontrada.</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function getLocationAndSubmit() {
        const btn = document.querySelector('#formCheckin button');
        const form = document.getElementById('formCheckin');

        // Loading state button
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Localizando...';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                form.submit();
            }, function (error) {
                // Tratamento de erro com Toast Nativo
                ToastModule.show("Erro ao obter localização. Verifique as permissões.", "danger");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, { timeout: 10000 });
        } else {
            ToastModule.show("Geolocalização não suportada.", "danger");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Função de Ordenação Manual
    function sortOSList() {
        const criteria = document.getElementById('sortSelect').value;
        const body = document.getElementById('osTableBody');
        const rows = Array.from(body.querySelectorAll('.os-row'));

        rows.sort((a, b) => {
            let valA, valB;
            const [field, order] = criteria.split('-');

            if (field === 'data') {
                valA = new Date(a.dataset.data);
                valB = new Date(b.dataset.data);
            } else if (field === 'prioridade') {
                valA = parseInt(a.dataset.prioridade);
                valB = parseInt(b.dataset.prioridade);
            } else if (field === 'status') {
                valA = parseInt(a.dataset.status);
                valB = parseInt(b.dataset.status);
            }

            if (order === 'asc') return valA > valB ? 1 : -1;
            return valA < valB ? 1 : -1;
        });

        rows.forEach(row => body.appendChild(row));
    }

    // Função de Filtro Rápido
    function filterOSList(term) {
        const lowerTerm = term.toLowerCase();
        const rows = document.querySelectorAll('.os-row');

        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(lowerTerm) ? '' : 'none';
        });
    }

    // Função para Aplicar Filtros de Unidade, Tipo e Status
    function aplicarFiltros() {
        const unidadeId = document.getElementById('unidadeFiltro').value;
        const tipo = document.getElementById('tipoFiltro').value;
        const status = document.getElementById('statusFiltro').value;

        const params = new URLSearchParams(window.location.search);

        // Atualizar parâmetros
        if (unidadeId) {
            params.set('unidade_id', unidadeId);
        } else {
            params.delete('unidade_id');
        }

        if (tipo) {
            params.set('tipo', tipo);
        } else {
            params.delete('tipo');
        }

        if (status && status !== 'aberta') {
            params.set('status', status);
        } else {
            params.delete('status');  // Remove para usar o padrão (aberta)
        }

        // Redirecionar com novos parâmetros
        window.location.href = '{{ url_for("ponto.index") }}?' + params.toString() + '#minhas-os';
    }
</script>
{% endblock %}