{% extends "base.html" %}

{% block content %}
<style>
    .chat-bubble { max-width: 70%; border-radius: 12px; }
    .chat-outbound { background-color: #dcf8c6; }
    .chat-inbound { background-color: #fff; border: 1px solid #e2e8f0; }
    #chatContainer { background-color: #e5ddd5; overflow-y: auto; }
</style>

<div class="row h-100 g-0" style="min-height: calc(100vh - 100px);">
    <!-- Sidebar com detalhes -->
    <div class="col-md-4 border-end bg-white h-100 overflow-auto">
        <div class="p-4">
            <a href="{{ url_for('terceirizados.listar_chamados') }}"
                class="text-decoration-none text-muted small mb-3 d-block">
                <i class="bi bi-arrow-left"></i> Voltar para Lista
            </a>

            <h4 class="fw-bold mb-1">{{ chamado.titulo }}</h4>
            <span class="badge bg-{{ 'success' if chamado.status == 'concluido' else 'warning' }} mb-3">
                {{ chamado.status|upper }}
            </span>

            <div class="card bg-light border-0 mb-3">
                <div class="card-body">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Prestador</small>
                    <div class="fw-bold">{{ chamado.terceirizado.nome }}</div>
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-whatsapp text-success"></i>
                        {{ chamado.terceirizado.telefone }}
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mt-4">Descri√ß√£o</h6>
            <p class="text-muted small bg-light p-3 rounded">{{ chamado.descricao }}</p>

            <div class="row g-2 mb-4">
                <div class="col-6">
                    <small class="text-muted d-block">Prazo</small>
                    <strong>{{ chamado.prazo_combinado.strftime('%d/%m %H:%M') }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Prioridade</small>
                    <strong>{{ chamado.prioridade|capitalize }}</strong>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                {% if chamado.status != 'concluido' %}
                <button class="btn btn-outline-danger" onclick="abrirModalCobranca()">
                    <i class="bi bi-bell me-2"></i>Enviar Cobran√ßa
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- √Årea do chat -->
    <div class="col-md-8 d-flex flex-column bg-light" style="height: calc(100vh - 100px);">
        <div class="p-3 border-bottom bg-white fw-bold text-muted d-flex align-items-center gap-2">
            <i class="bi bi-chat-text-fill text-primary"></i>
            Conversa com {{ chamado.terceirizado.nome }}
        </div>

        <div class="flex-grow-1 p-3 overflow-auto" id="chatContainer">
            <div class="text-center text-muted py-5" id="emptyState">
                <i class="bi bi-chat-square-dots fs-1 d-block mb-2 opacity-25"></i>
                <p>Carregando mensagens...</p>
            </div>
        </div>

        <div class="p-3 bg-white border-top">
            <form id="formChat" onsubmit="enviarMensagem(event)">
                <div class="input-group">
                    <input type="text" id="inputMsg" class="form-control bg-light"
                        placeholder="Digite uma mensagem para o prestador..." required>
                    <button type="submit" id="btnEnviar" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Cobran√ßa -->
<div class="modal fade" id="modalCobranca" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">Enviar Cobran√ßa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label small text-muted text-uppercase fw-bold">Mensagem via WhatsApp</label>
                <textarea class="form-control" id="textoCobranca" rows="6" style="resize: none;"></textarea>
                <div class="form-text mt-2 small">Voc√™ pode editar o texto antes de enviar.</div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-white border" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnConfirmarCobranca" class="btn btn-primary" onclick="confirmarCobranca()">
                    <i class="bi bi-send me-2"></i>Enviar Agora
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const CHAMADO_ID = {{ chamado.id }};
const NUMERO_CHAMADO = "{{ chamado.numero_chamado }}";
const TITULO_CHAMADO = "{{ chamado.titulo }}";
let ultimoIdVisto = 0;
let pollingInterval = null;

function criarBalao(msg) {
    const isOut = msg.direcao === 'outbound';
    const div = document.createElement('div');
    div.className = `d-flex mb-3 ${isOut ? 'justify-content-end' : 'justify-content-start'}`;
    div.dataset.msgId = msg.id;

    let conteudo = '';
    if (msg.tipo_conteudo === 'audio') {
        conteudo = 'üé§ √Åudio';
    } else if (msg.tipo_conteudo === 'image') {
        conteudo = 'üì∑ Imagem';
    } else if (msg.tipo_conteudo === 'document') {
        conteudo = 'üìÑ Documento';
    } else {
        conteudo = msg.mensagem.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    div.innerHTML = `
        <div class="card border-0 shadow-sm chat-bubble ${isOut ? 'chat-outbound' : 'chat-inbound'}">
            <div class="card-body p-2 px-3">
                <div class="small mb-1 text-dark" style="white-space: pre-wrap;">${conteudo}</div>
                <div class="d-flex align-items-center justify-content-end gap-1 opacity-50" style="font-size: 0.65rem;">
                    <span>${msg.hora}</span>
                    ${isOut ? '<i class="bi bi-check2-all"></i>' : ''}
                </div>
            </div>
        </div>`;
    return div;
}

function carregarMensagens(scroll) {
    fetch(`/terceirizados/chamados/${CHAMADO_ID}/mensagens`)
        .then(r => r.json())
        .then(msgs => {
            const container = document.getElementById('chatContainer');
            const emptyState = document.getElementById('emptyState');

            if (msgs.length === 0) {
                if (emptyState) emptyState.innerHTML = '<i class="bi bi-chat-square-dots fs-1 d-block mb-2 opacity-25"></i><p>Nenhuma mensagem trocada ainda.</p>';
                return;
            }

            if (emptyState) emptyState.remove();

            // Adicionar apenas mensagens novas
            msgs.forEach(msg => {
                if (msg.id > ultimoIdVisto) {
                    if (!container.querySelector(`[data-msg-id="${msg.id}"]`)) {
                        container.appendChild(criarBalao(msg));
                    }
                    ultimoIdVisto = msg.id;
                }
            });

            if (scroll) {
                container.scrollTop = container.scrollHeight;
            }
        })
        .catch(err => console.error('Erro ao carregar mensagens:', err));
}

function enviarMensagem(e) {
    e.preventDefault();
    const input = document.getElementById('inputMsg');
    const btn = document.getElementById('btnEnviar');
    const msg = input.value.trim();
    if (!msg) return;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/terceirizados/chamados/${CHAMADO_ID}/responder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `mensagem=${encodeURIComponent(msg)}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            carregarMensagens(true);
        } else {
            alert('Erro: ' + data.msg);
        }
    })
    .catch(() => alert('Erro de conex√£o.'))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send"></i>';
    });
}

function abrirModalCobranca() {
    const texto = `‚è∞ *Prazo Vencido*\n\nChamado: ${NUMERO_CHAMADO}\nT√≠tulo: ${TITULO_CHAMADO}\nPrevis√£o de conclus√£o?`;
    document.getElementById('textoCobranca').value = texto;
    new bootstrap.Modal(document.getElementById('modalCobranca')).show();
}

function confirmarCobranca() {
    const btn = document.getElementById('btnConfirmarCobranca');
    const msg = document.getElementById('textoCobranca').value;
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Enviando...';

    fetch(`/terceirizados/chamados/${CHAMADO_ID}/cobrar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mensagem_personalizada: msg })
    })
    .then(r => r.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('modalCobranca')).hide();
        if (typeof ToastModule !== 'undefined') {
            ToastModule.show(data.msg, data.success ? 'success' : 'danger');
        } else {
            alert(data.msg);
        }
        if (data.success) carregarMensagens(true);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = original;
    });
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    carregarMensagens(true);
    // Polling a cada 5 segundos para novas mensagens
    pollingInterval = setInterval(() => carregarMensagens(false), 5000);
});

// Limpar polling ao sair da p√°gina
window.addEventListener('beforeunload', () => clearInterval(pollingInterval));
</script>
{% endblock %}
