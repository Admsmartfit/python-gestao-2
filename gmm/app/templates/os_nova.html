{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb" class="mb-1">
        <ol class="breadcrumb mb-0" style="font-size: 0.75rem;">
            <li class="breadcrumb-item"><a href="{{ url_for('ponto.index') }}"
                    class="text-decoration-none">Dashboard</a></li>
            <li class="breadcrumb-item active">Nova OS</li>
        </ol>
    </nav>
    <div class="d-flex align-items-center justify-content-between">
        <h2 class="mb-0 fw-bold">Nova Ordem de Serviço</h2>
        <a href="{{ url_for('ponto.index') }}" class="btn btn-secondary btn-sm">Cancelar</a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="formOS">

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0 text-primary"><i class="bi bi-geo-alt-fill me-2"></i>Local e Equipamento</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Unidade</label>
                    <select name="unidade_id" id="selectUnidade" class="form-select" required
                        onchange="carregarEquipamentos()">
                        <option value="" disabled {% if not equipamento_preselect %}selected{% endif %}>Selecione...</option>
                        {% for u in unidades %}
                        <option value="{{ u.id }}" {% if equipamento_preselect and equipamento_preselect.unidade_id == u.id %}selected{% endif %}>{{ u.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Técnico Responsável</label>
                    <select name="tecnico_id" class="form-select" required>
                        {% for t in tecnicos %}
                        <option value="{{ t.id }}" {% if t.id==current_user.id %}selected{% endif %}>{{ t.nome
                            }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12">
                    <hr class="text-muted opacity-25 my-1">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Filtro de Categoria</label>
                    <select id="selectCategoria" class="form-select" onchange="carregarEquipamentos()">
                        <option value="" selected>Todas</option>
                        <option value="cardio">Cardio</option>
                        <option value="musculacao">Musculação</option>
                        <option value="predial">Predial</option>
                        <option value="diversos">Diversos</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Equipamento</label>
                    <select name="equipamento_id" id="selectEquipamento" class="form-select" required {% if not equipamento_preselect %}disabled{% endif %}>
                        {% if equipamento_preselect %}
                        <option value="{{ equipamento_preselect.id }}" selected>{{ equipamento_preselect.nome }}</option>
                        {% else %}
                        <option value="">Selecione a Unidade primeiro...</option>
                        {% endif %}
                    </select>
                    {% if equipamento_preselect %}
                    <input type="hidden" id="equipamentoPreselect" value="{{ equipamento_preselect.id }}">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0 text-secondary"><i class="bi bi-tools me-2"></i>Detalhes do Problema</h5>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Tipo de Manutenção</label>
                    <select name="tipo_manutencao" class="form-select">
                        <option value="corretiva">Corretiva (Quebrou)</option>
                        <option value="preventiva">Preventiva (Revisão)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Prioridade</label>
                    <select name="prioridade" class="form-select">
                        <option value="baixa">Baixa</option>
                        <option value="media" selected>Média</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label text-danger">Prazo Limite</label>
                    <input type="datetime-local" name="prazo_conclusao" class="form-control border-danger-subtle"
                        required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label d-flex justify-content-between align-items-center">
                    Descrição do Problema
                    <button type="button" class="btn btn-sm btn-link text-decoration-none p-0"
                        onclick="iniciarDitado('descricao_problema')">
                        <i class="bi bi-mic-fill text-primary"></i> <span id="micText">Ditar Texto</span>
                    </button>
                </label>
                <textarea name="descricao_problema" id="descricao_problema" class="form-control" rows="4" required
                    placeholder="Descreva o defeito detalhadamente..."></textarea>
                <div id="micStatus" class="form-text text-primary d-none fw-bold"><i
                        class="bi bi-record-circle me-1 blink"></i> Ouvindo...</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Fotos Iniciais</label>

                <!-- Botões de ação para fotos -->
                <div class="d-flex gap-2 mb-3 flex-wrap">
                    <button type="button" class="btn btn-outline-primary flex-grow-1" onclick="tirarFoto()">
                        <i class="bi bi-camera-fill me-2"></i>Tirar Foto
                    </button>
                    <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="escolherArquivos()">
                        <i class="bi bi-image me-2"></i>Galeria
                    </button>
                </div>

                <!-- Input oculto para câmera (capture) -->
                <input type="file" id="inputCamera" accept="image/*" capture="environment" class="d-none" onchange="adicionarFotoCapturada(this)">

                <!-- Input oculto para galeria (múltiplos) -->
                <input type="file" id="inputGaleria" accept="image/*" multiple class="d-none" onchange="adicionarFotosGaleria(this)">

                <!-- Input real que será enviado no form -->
                <input type="file" name="fotos_antes" id="inputFotos" multiple accept="image/*" class="d-none">

                <!-- Preview das fotos -->
                <div id="previewFotos" class="row g-2"></div>

                <!-- Contador de fotos -->
                <div id="contadorFotos" class="text-muted small mt-2 d-none">
                    <i class="bi bi-images me-1"></i><span id="numFotos">0</span> foto(s) selecionada(s)
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 mb-5">
        <button type="submit" class="btn btn-primary btn-lg shadow-sm">
            <i class="bi bi-check-lg me-2"></i> Criar Ordem de Serviço
        </button>
    </div>
</form>

<script>
    // Lógica de equipamentos (AJAX) - Mantida funcionalidade, ajustada UI
    async function carregarEquipamentos(preselectId = null) {
        const unidadeId = document.getElementById('selectUnidade').value;
        const categoria = document.getElementById('selectCategoria').value;
        const selectEquip = document.getElementById('selectEquipamento');

        if (!unidadeId) {
            selectEquip.innerHTML = '<option value="">Selecione primeiro a Unidade...</option>';
            selectEquip.disabled = true;
            return;
        }

        selectEquip.disabled = true;
        selectEquip.innerHTML = '<option>Carregando...</option>';

        try {
            let url = `/os/api/equipamentos/filtro?unidade_id=${unidadeId}`;
            if (categoria) url += `&categoria=${categoria}`;

            const response = await fetch(url);
            const equipamentos = await response.json();

            selectEquip.innerHTML = '<option value="" disabled>Escolha o equipamento...</option>';
            if (equipamentos.length === 0) {
                selectEquip.innerHTML += '<option value="" disabled>Nenhum equipamento encontrado.</option>';
            } else {
                equipamentos.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.text = eq.nome;
                    // Pré-selecionar se houver ID
                    if (preselectId && eq.id == preselectId) {
                        option.selected = true;
                    }
                    selectEquip.appendChild(option);
                });
                // Se não houver pré-seleção, selecionar a primeira opção vazia
                if (!preselectId) {
                    selectEquip.querySelector('option[value=""]').selected = true;
                }
            }
            selectEquip.disabled = false;
        } catch (error) {
            console.error(error);
            selectEquip.innerHTML = '<option>Erro ao carregar.</option>';
        }
    }

    // Carregar equipamentos automaticamente se houver pré-seleção (QR Code)
    document.addEventListener('DOMContentLoaded', function() {
        const preselectInput = document.getElementById('equipamentoPreselect');
        if (preselectInput) {
            const unidadeId = document.getElementById('selectUnidade').value;
            if (unidadeId) {
                carregarEquipamentos(preselectInput.value);
            }
        }
    });

    // === SISTEMA DE FOTOS COM CÂMERA ===
    const FotosModule = (function() {
        let fotosArray = []; // Array para armazenar os arquivos de foto

        function tirarFoto() {
            document.getElementById('inputCamera').click();
        }

        function escolherArquivos() {
            document.getElementById('inputGaleria').click();
        }

        function adicionarFotoCapturada(input) {
            if (input.files && input.files[0]) {
                adicionarFoto(input.files[0]);
                input.value = ''; // Reset para permitir tirar outra foto
            }
        }

        function adicionarFotosGaleria(input) {
            if (input.files) {
                for (let file of input.files) {
                    adicionarFoto(file);
                }
                input.value = ''; // Reset
            }
        }

        function adicionarFoto(file) {
            // Adicionar ao array
            const index = fotosArray.length;
            fotosArray.push(file);

            // Criar preview
            const container = document.getElementById('previewFotos');
            const col = document.createElement('div');
            col.className = 'col-4 col-md-3 col-lg-2';
            col.id = `foto-preview-${index}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                col.innerHTML = `
                    <div class="position-relative">
                        <img src="${e.target.result}" class="img-fluid rounded border shadow-sm"
                             style="width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer;"
                             onclick="FotosModule.ampliarFoto('${e.target.result}')">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 rounded-circle p-0"
                                style="width: 24px; height: 24px; line-height: 1;"
                                onclick="FotosModule.removerFoto(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
            container.appendChild(col);

            // Atualizar o input real do formulário
            atualizarInputForm();
            atualizarContador();
        }

        function removerFoto(index) {
            // Marcar como null (não removemos para manter índices)
            fotosArray[index] = null;

            // Remover preview
            const preview = document.getElementById(`foto-preview-${index}`);
            if (preview) preview.remove();

            // Atualizar input
            atualizarInputForm();
            atualizarContador();
        }

        function atualizarInputForm() {
            // Criar um novo DataTransfer para simular FileList
            const dt = new DataTransfer();
            fotosArray.forEach(file => {
                if (file) dt.items.add(file);
            });

            // Atualizar o input real
            document.getElementById('inputFotos').files = dt.files;
        }

        function atualizarContador() {
            const count = fotosArray.filter(f => f !== null).length;
            const contador = document.getElementById('contadorFotos');
            const numFotos = document.getElementById('numFotos');

            if (count > 0) {
                contador.classList.remove('d-none');
                numFotos.textContent = count;
            } else {
                contador.classList.add('d-none');
            }
        }

        function ampliarFoto(src) {
            // Criar modal de ampliação
            const modalHtml = `
                <div class="modal fade" id="modalAmpliarFoto" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content bg-dark">
                            <div class="modal-header border-0">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-0 text-center">
                                <img src="${src}" class="img-fluid" style="max-height: 80vh;">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal anterior se existir
            const existing = document.getElementById('modalAmpliarFoto');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('modalAmpliarFoto'));
            modal.show();

            document.getElementById('modalAmpliarFoto').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        return {
            tirarFoto,
            escolherArquivos,
            adicionarFotoCapturada,
            adicionarFotosGaleria,
            removerFoto,
            ampliarFoto
        };
    })();

    // Expor funções globalmente para os botões
    window.tirarFoto = FotosModule.tirarFoto;
    window.escolherArquivos = FotosModule.escolherArquivos;
    window.adicionarFotoCapturada = FotosModule.adicionarFotoCapturada;
    window.adicionarFotosGaleria = FotosModule.adicionarFotosGaleria;
    window.FotosModule = FotosModule;

    // Reconhecimento de Voz (UI Feedback melhorado)
    function iniciarDitado(targetId) {
        if (!('webkitSpeechRecognition' in window)) {
            ToastModule.show("Seu navegador não suporta ditado.", "warning");
            return;
        }
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';

        const statusElem = document.getElementById('micStatus');
        const micText = document.getElementById('micText');
        const inputElem = document.getElementById(targetId);

        recognition.onstart = function () {
            statusElem.classList.remove('d-none');
            micText.innerText = "Parar";
        };

        recognition.onend = function () {
            statusElem.classList.add('d-none');
            micText.innerText = "Ditar Texto";
        };

        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            const atual = inputElem.value;
            inputElem.value = atual ? atual + " " + transcript : transcript;
        };

        recognition.start();
    }
</script>

<style>
    .blink {
        animation: blinker 1.5s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0;
        }
    }
</style>
{% endblock %}