{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Configurações</a></li>
<li class="breadcrumb-item active">Relatório de Movimentações</li>
{% endblock %}

{% block content %}
<div class="mb-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div>
        <nav aria-label="breadcrumb" class="mb-1">
            <ol class="breadcrumb mb-0" style="font-size: 0.75rem;">
                <li class="breadcrumb-item"><a href="{{ url_for('ponto.index') }}"
                        class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item active">Relatório de Movimentações</li>
            </ol>
        </nav>
        <h2 class="mb-0 fw-bold">Movimentações</h2>
        <p class="mb-0 text-muted small">Histórico detalhado de entradas, saídas e transferências.</p>
    </div>
    <a href="{{ url_for('admin.exportar_movimentacoes_csv', **filters) }}" class="btn btn-secondary">
        <i class="bi bi-download"></i> Exportar CSV
    </a>
</div>

<!-- Filtros -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold">Unidade</label>
                <select name="unidade_id" class="form-select">
                    <option value="">Todas as Unidades</option>
                    {% for u in unidades %}
                    <option value="{{ u.id }}" {{ 'selected' if filters.get('unidade_id')|int==u.id }}>{{ u.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">Tipo</label>
                <select name="tipo" class="form-select">
                    <option value="">Todos os Tipos</option>
                    <option value="entrada" {{ 'selected' if filters.get('tipo')=='entrada' }}>Entrada</option>
                    <option value="saida" {{ 'selected' if filters.get('tipo')=='saida' }}>Saída</option>
                    <option value="ajuste" {{ 'selected' if filters.get('tipo')=='ajuste' }}>Ajuste</option>
                    <option value="devolucao" {{ 'selected' if filters.get('tipo')=='devolucao' }}>Devolução</option>
                    <option value="transferencia_entrada" {{ 'selected' if filters.get('tipo')=='transferencia_entrada'
                        }}>
                        Transferência (Entrada)</option>
                    <option value="transferencia_saida" {{ 'selected' if filters.get('tipo')=='transferencia_saida' }}>
                        Transferência (Saída)</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Data Início</label>
                <input type="date" name="data_inicio" class="form-control" value="{{ filters.data_inicio }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Data Fim</label>
                <input type="date" name="data_fim" class="form-control" value="{{ filters.data_fim }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter me-2"></i>Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de Resultados -->
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Data/Hora</th>
                        <th>Item</th>
                        <th>Tipo</th>
                        <th>Qtd</th>
                        <th>Unidade</th>
                        <th>Usuário</th>
                        <th>Observação / OS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in movimentacoes %}
                    <tr>
                        <td class="ps-4 text-muted small">
                            {{ m.data_movimentacao.strftime('%d/%m/%Y %H:%M') }}
                        </td>
                        <td>
                            <div class="fw-bold text-dark">{{ m.estoque.nome }}</div>
                            <small class="text-muted">{{ m.estoque.codigo }}</small>
                        </td>
                        <td>
                            {% if m.tipo_movimentacao == 'entrada' or m.tipo_movimentacao == 'transferencia_entrada' %}
                            <span class="badge bg-success bg-opacity-10 text-success">
                                <i class="bi bi-arrow-down-left me-1"></i>{{ m.tipo_movimentacao|capitalize }}
                            </span>
                            {% elif m.tipo_movimentacao == 'saida' or m.tipo_movimentacao == 'transferencia_saida' %}
                            <span class="badge bg-danger bg-opacity-10 text-danger">
                                <i class="bi bi-arrow-up-right me-1"></i>{{ m.tipo_movimentacao|capitalize }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                <i class="bi bi-gear me-1"></i>{{ m.tipo_movimentacao|capitalize }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="fw-bold">
                            {{ "{:g}".format(m.quantidade) }}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark fw-normal">{{ m.unidade.nome if m.unidade else '-'
                                }}</span>
                        </td>
                        <td>
                            <div class="small">{{ m.usuario.nome }}</div>
                        </td>
                        <td>
                            {% if m.os_id %}
                            <a href="{{ url_for('os.detalhes', id=m.os_id) }}"
                                class="badge bg-primary bg-opacity-10 text-primary text-decoration-none">
                                <i class="bi bi-file-text me-1"></i>OS #{{ m.os.numero_os if m.os else m.os_id }}
                            </a>
                            {% endif %}
                            <div class="small text-muted mt-1">{{ m.observacao or '-' }}</div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-search fs-1 d-block mb-2"></i>
                            Nenhuma movimentação encontrada com os filtros aplicados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}