Este Ã© o manual completo de instalaÃ§Ã£o do **Sistema GMM (GestÃ£o Moderna de ManutenÃ§Ã£o)** em ambiente Linux, integrando o guia tÃ©cnico de requisitos com o novo mÃ³dulo **Setup Wizard** para configuraÃ§Ã£o simplificada.

---

# ðŸ§ Manual do Instalador - Sistema GMM (Linux)

## 1. VisÃ£o Geral e Requisitos de Sistema

O GMM Ã© uma aplicaÃ§Ã£o Flask para gestÃ£o de manutenÃ§Ã£o com suporte a tarefas assÃ­ncronas via Celery e Redis.

* **Sistema Operacional**: Ubuntu 20.04+, Debian 11+, CentOS 8+ ou similar.
* **Python**: VersÃ£o 3.9 ou superior.
* **Redis**: VersÃ£o 5.0 ou superior (obrigatÃ³rio para o Celery).
* **RAM**: MÃ­nimo de 2GB (4GB recomendado).
* **EspaÃ§o em Disco**: MÃ­nimo de 500MB livres para a aplicaÃ§Ã£o, sendo recomendado 1GB livre para o Setup Wizard.

---

## 2. PreparaÃ§Ã£o e InstalaÃ§Ã£o Automatizada

O sistema fornece um script para configurar as dependÃªncias bÃ¡sicas do Linux antes de iniciar a configuraÃ§Ã£o web.

1. **Copie os arquivos** necessÃ¡rios para o servidor, mantendo a estrutura original das pastas `app/`, `config/`, `migrations/`, `instance/` e os scripts da raiz.
2. **DÃª permissÃ£o de execuÃ§Ã£o** e inicie o script como root:
```bash
chmod +x install_linux.sh
sudo ./install_linux.sh

```


3. **AÃ§Ãµes do Script**:
* Detecta a distribuiÃ§Ã£o Linux e instala Python 3.9+, Redis e ferramentas de compilaÃ§Ã£o.
* Cria o ambiente virtual (`venv`) e instala as dependÃªncias do `requirements.txt`.
* Cria a estrutura de pastas para uploads em `app/static/uploads/{audios,chamados,os}`.
* Garante permissÃµes de escrita para o usuÃ¡rio real.



---

## 3. ConfiguraÃ§Ã£o via Setup Wizard (Interface Web)

O GMM possui um assistente de configuraÃ§Ã£o interativo que substitui a ediÃ§Ã£o manual do arquivo `.env`.

### InicializaÃ§Ã£o

Se o arquivo `.env` nÃ£o existir, ao executar `python run.py`, o sistema redirecionarÃ¡ automaticamente para a rota `/setup`. Acesse `http://IP-DO-SERVIDOR:5000` no seu navegador.

### Etapas do Assistente:

* **Etapa 1: VerificaÃ§Ã£o de Ambiente**: Valida a versÃ£o do Python, permissÃµes de escrita, se o Redis estÃ¡ rodando e o espaÃ§o em disco.
* **Etapa 2: SeguranÃ§a**: Gera automaticamente a `SECRET_KEY` (proteÃ§Ã£o de sessÃµes) e a `FERNET_KEY` (criptografia de tokens e senhas).
* **Etapa 3: Banco de Dados**:
* **SQLite**: Configura o caminho absoluto para o banco em `instance/gmm.db`.
* **PostgreSQL**: Permite inserir Host, Porta, UsuÃ¡rio e Senha, com validaÃ§Ã£o de conexÃ£o em tempo real.


* **Etapa 4: Conectividade**: Configura as chaves da **MegaAPI (WhatsApp)** e credenciais de e-mail (SMTP/IMAP) para notificaÃ§Ãµes, permitindo o envio de mensagens de teste.
* **Etapa 5: InteligÃªncia Artificial (Opcional)**: Configura a API Key da OpenAI para transcriÃ§Ã£o de Ã¡udios e comandos de voz.
* **FinalizaÃ§Ã£o**: Salva o arquivo `.env`, cria a trava de seguranÃ§a `instance/setup.lock` e limpa a sessÃ£o.

---

## 4. InicializaÃ§Ã£o e ServiÃ§os em ProduÃ§Ã£o

ApÃ³s concluir o Setup Wizard, o sistema deve ser reiniciado para carregar as novas configuraÃ§Ãµes.

### Comandos de InicializaÃ§Ã£o (Manual)

Abra terminais separados ou use o `start_linux.sh`:

1. **Flask**: `python run.py`.
2. **Celery Worker**: `celery -A app.celery worker --loglevel=info`.
3. **Celery Beat**: `celery -A app.celery beat --loglevel=info`.

### ConfiguraÃ§Ã£o com Systemd (Recomendado)

Para rodar como serviÃ§o de sistema, utilize o modelo abaixo para o arquivo `/etc/systemd/system/gmm-flask.service`:

```ini
[Unit]
Description=GMM Flask Application
After=network.target redis.service

[Service]
Type=simple
User=seu-usuario
WorkingDirectory=/caminho/para/gmm
Environment="PATH=/caminho/para/gmm/venv/bin"
ExecStart=/caminho/para/gmm/venv/bin/python run.py
Restart=always

[Install]
WantedBy=multi-user.target

```

Repita o processo para os serviÃ§os do Celery (`gmm-celery.service` e `gmm-celery-beat.service`) conforme detalhado no script de instalaÃ§Ã£o.

---

## 5. VerificaÃ§Ã£o e Acesso

* **Login PadrÃ£o**: UsuÃ¡rio `admin` / Senha `admin123`.
* **âš ï¸ SeguranÃ§a**: Altere a senha padrÃ£o imediatamente apÃ³s o primeiro login e mantenha o arquivo `.env` com permissÃµes restritas.
* **ReconfiguraÃ§Ã£o**: Caso precise refazer o processo, delete os arquivos `.env` e `instance/setup.lock`.

Gostaria que eu detalhasse a criaÃ§Ã£o dos arquivos de serviÃ§o do Celery para o Systemd?

Aqui estÃ£o os comandos prontos para configurar o **Systemd** no seu servidor Linux. Estes comandos criam os trÃªs serviÃ§os necessÃ¡rios para o pleno funcionamento do GMM: a aplicaÃ§Ã£o Web, o processador de tarefas e o agendador.

### 1. Defina as VariÃ¡veis de Ambiente

Substitua `/caminho/para/gmm` pelo caminho real da pasta onde instalou o sistema e `seu-utilizador` pelo nome do utilizador Linux que serÃ¡ o dono dos ficheiros.

```bash
# Exemplo: INSTALL_DIR="/home/ubuntu/gmm" e REAL_USER="ubuntu"
INSTALL_DIR="/caminho/para/gmm"
REAL_USER="seu-utilizador"

```

### 2. Criar o ServiÃ§o Flask (Interface Web)

Este comando cria o serviÃ§o que mantÃ©m o site online.

```bash
sudo bash -c "cat > /etc/systemd/system/gmm-flask.service << EOF
[Unit]
Description=GMM Flask Application
After=network.target redis.service

[Service]
Type=simple
User=$REAL_USER
WorkingDirectory=$INSTALL_DIR
Environment=\"PATH=$INSTALL_DIR/venv/bin\"
EnvironmentFile=$INSTALL_DIR/.env
ExecStart=$INSTALL_DIR/venv/bin/python run.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF"

```

### 3. Criar o ServiÃ§o Celery Worker (Tarefas)

Este serviÃ§o processa tarefas como o envio de mensagens de WhatsApp em segundo plano.

```bash
sudo bash -c "cat > /etc/systemd/system/gmm-celery.service << EOF
[Unit]
Description=GMM Celery Worker
After=network.target redis.service

[Service]
Type=simple
User=$REAL_USER
WorkingDirectory=$INSTALL_DIR
Environment=\"PATH=$INSTALL_DIR/venv/bin\"
EnvironmentFile=$INSTALL_DIR/.env
ExecStart=$INSTALL_DIR/venv/bin/celery -A app.celery worker --loglevel=info
Restart=always

[Install]
WantedBy=multi-user.target
EOF"

```

### 4. Criar o ServiÃ§o Celery Beat (Agendador)

Este serviÃ§o Ã© responsÃ¡vel por tarefas que ocorrem em horÃ¡rios especÃ­ficos, como verificaÃ§Ãµes automÃ¡ticas.

```bash
sudo bash -c "cat > /etc/systemd/system/gmm-celery-beat.service << EOF
[Unit]
Description=GMM Celery Beat Scheduler
After=network.target redis.service

[Service]
Type=simple
User=$REAL_USER
WorkingDirectory=$INSTALL_DIR
Environment=\"PATH=$INSTALL_DIR/venv/bin\"
EnvironmentFile=$INSTALL_DIR/.env
ExecStart=$INSTALL_DIR/venv/bin/celery -A app.celery beat --loglevel=info
Restart=always

[Install]
WantedBy=multi-user.target
EOF"

```

### 5. Ativar e Iniciar os ServiÃ§os

Execute estes comandos para recarregar o Linux e colocar tudo a funcionar imediatamente:

```bash
# Recarregar as configuraÃ§Ãµes do sistema
sudo systemctl daemon-reload

# Ativar para iniciarem automaticamente no boot
sudo systemctl enable gmm-flask gmm-celery gmm-celery-beat

# Iniciar os serviÃ§os agora
sudo systemctl start gmm-flask gmm-celery gmm-celery-beat

```

### 6. Como verificar se estÃ¡ tudo OK?

Pode verificar o estado de qualquer serviÃ§o e ler os logs em tempo real:

* **Verificar estado:** `sudo systemctl status gmm-flask`
* **Ver logs do Flask:** `sudo journalctl -u gmm-flask -f`
* **Ver logs do WhatsApp/Tarefas:** `sudo journalctl -u gmm-celery -f`

**AtenÃ§Ã£o:** Certifique-se de que jÃ¡ concluiu o **Setup Wizard** via navegador antes de iniciar estes serviÃ§os, para que o ficheiro `.env` esteja presente e configurado.